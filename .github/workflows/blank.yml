export default {
  async fetch(request) {
    const url = new URL(request.url);
    const path = url.pathname;
    const params = url.searchParams;

    if (path === "/check") {
      return await handleCheck(params);
    }

    return new Response(generateHTML(), {
      headers: { "Content-Type": "text/html" },
    });
  }
};

async function handleCheck(params) {
  const ipPort = params.get("ip");

  if (!ipPort) {
    return new Response("Parameter 'ip' diperlukan dalam format ip:port", { status: 400 });
  }

  const [ip, port] = ipPort.split(":");
  if (!ip || !port) {
    return new Response("Format IP:PORT tidak valid", { status: 400 });
  }

  const apiUrl = `https://p01--boiling-frame--kw6dd7bjv2nr.code.run/check?ip=${ip}&port=${port}&host=speed.cloudflare.com&tls=true`;

  try {
    const startTime = Date.now();
    const apiResponse = await fetch(apiUrl);
    const endTime = Date.now();
    let latency = endTime - startTime;
    latency = Math.round(latency / 150) + ".ms";

    const result = await apiResponse.json();
    
    const flags = {
      "AD": "ğŸ‡¦ğŸ‡©", "AE": "ğŸ‡¦ğŸ‡ª", "AF": "ğŸ‡¦ğŸ‡«", "AG": "ğŸ‡¦ğŸ‡¬", "AI": "ğŸ‡¦ğŸ‡®", "AL": "ğŸ‡¦ğŸ‡±", "AM": "ğŸ‡¦ğŸ‡²", "AO": "ğŸ‡¦ğŸ‡´",
      "AR": "ğŸ‡¦ğŸ‡·", "AT": "ğŸ‡¦ğŸ‡¹", "AU": "ğŸ‡¦ğŸ‡º", "AW": "ğŸ‡¦ğŸ‡¼", "AZ": "ğŸ‡¦ğŸ‡¿", "BA": "ğŸ‡§ğŸ‡¦", "BB": "ğŸ‡§ğŸ‡§", "BD": "ğŸ‡§ğŸ‡©",
      "BE": "ğŸ‡§ğŸ‡ª", "BF": "ğŸ‡§ğŸ‡«", "BG": "ğŸ‡§ğŸ‡¬", "BH": "ğŸ‡§ğŸ‡­", "BI": "ğŸ‡§ğŸ‡®", "BJ": "ğŸ‡§ğŸ‡¯", "BN": "ğŸ‡§ğŸ‡³", "BO": "ğŸ‡§ğŸ‡´",
      "BR": "ğŸ‡§ğŸ‡·", "BS": "ğŸ‡§ğŸ‡¸", "BT": "ğŸ‡§ğŸ‡¹", "BW": "ğŸ‡§ğŸ‡¼", "BY": "ğŸ‡§ğŸ‡¾", "BZ": "ğŸ‡§ğŸ‡¿", "CA": "ğŸ‡¨ğŸ‡¦", "CD": "ğŸ‡¨ğŸ‡©",
      "CF": "ğŸ‡¨ğŸ‡«", "CG": "ğŸ‡¨ğŸ‡¬", "CH": "ğŸ‡¨ğŸ‡­", "CI": "ğŸ‡¨ğŸ‡®", "CL": "ğŸ‡¨ğŸ‡±", "CM": "ğŸ‡¨ğŸ‡²", "CN": "ğŸ‡¨ğŸ‡³", "CO": "ğŸ‡¨ğŸ‡´",
      "CR": "ğŸ‡¨ğŸ‡·", "CU": "ğŸ‡¨ğŸ‡º", "CV": "ğŸ‡¨ğŸ‡»", "CY": "ğŸ‡¨ğŸ‡¾", "CZ": "ğŸ‡¨ğŸ‡¿", "DE": "ğŸ‡©ğŸ‡ª", "DJ": "ğŸ‡©ğŸ‡¯", "DK": "ğŸ‡©ğŸ‡°",
      "DM": "ğŸ‡©ğŸ‡²", "DO": "ğŸ‡©ğŸ‡´", "DZ": "ğŸ‡©ğŸ‡¿", "EC": "ğŸ‡ªğŸ‡¨", "EE": "ğŸ‡ªğŸ‡ª", "EG": "ğŸ‡ªğŸ‡¬", "ER": "ğŸ‡ªğŸ‡·", "ES": "ğŸ‡ªğŸ‡¸",
      "ET": "ğŸ‡ªğŸ‡¹", "FI": "ğŸ‡«ğŸ‡®", "FJ": "ğŸ‡«ğŸ‡¯", "FM": "ğŸ‡«ğŸ‡²", "FR": "ğŸ‡«ğŸ‡·", "GA": "ğŸ‡¬ğŸ‡¦", "GB": "ğŸ‡¬ğŸ‡§", "GD": "ğŸ‡¬ğŸ‡©",
      "GE": "ğŸ‡¬ğŸ‡ª", "GH": "ğŸ‡¬ğŸ‡­", "GM": "ğŸ‡¬ğŸ‡²", "GN": "ğŸ‡¬ğŸ‡³", "GQ": "ğŸ‡¬ğŸ‡¶", "GR": "ğŸ‡¬ğŸ‡·", "GT": "ğŸ‡¬ğŸ‡¹", "GW": "ğŸ‡¬ğŸ‡¼",
      "GY": "ğŸ‡¬ğŸ‡¾", "HN": "ğŸ‡­ğŸ‡³", "HR": "ğŸ‡­ğŸ‡·", "HT": "ğŸ‡­ğŸ‡¹", "HU": "ğŸ‡­ğŸ‡º", "ID": "ğŸ‡®ğŸ‡©", "IE": "ğŸ‡®ğŸ‡ª", "IL": "ğŸ‡®ğŸ‡±",
      "IN": "ğŸ‡®ğŸ‡³", "IQ": "ğŸ‡®ğŸ‡¶", "IR": "ğŸ‡®ğŸ‡·", "IS": "ğŸ‡®ğŸ‡¸", "IT": "ğŸ‡®ğŸ‡¹", "JM": "ğŸ‡¯ğŸ‡²", "JO": "ğŸ‡¯ğŸ‡´", "JP": "ğŸ‡¯ğŸ‡µ",
      "KE": "ğŸ‡°ğŸ‡ª", "KG": "ğŸ‡°ğŸ‡¬", "KH": "ğŸ‡°ğŸ‡­", "KI": "ğŸ‡°ğŸ‡®", "KM": "ğŸ‡°ğŸ‡²", "KN": "ğŸ‡°ğŸ‡³", "KP": "ğŸ‡°ğŸ‡µ", "KR": "ğŸ‡°ğŸ‡·",
      "KW": "ğŸ‡°ğŸ‡¼", "KZ": "ğŸ‡°ğŸ‡¿", "LA": "ğŸ‡±ğŸ‡¦", "LB": "ğŸ‡±ğŸ‡§", "LC": "ğŸ‡±ğŸ‡¨", "LI": "ğŸ‡±ğŸ‡®", "LK": "ğŸ‡±ğŸ‡°", "LR": "ğŸ‡±ğŸ‡·",
      "LS": "ğŸ‡±ğŸ‡¸", "LT": "ğŸ‡±ğŸ‡¹", "LU": "ğŸ‡±ğŸ‡º", "LV": "ğŸ‡±ğŸ‡»", "LY": "ğŸ‡±ğŸ‡¾", "MA": "ğŸ‡²ğŸ‡¦", "MC": "ğŸ‡²ğŸ‡¨", "MD": "ğŸ‡²ğŸ‡©",
      "ME": "ğŸ‡²ğŸ‡ª", "MG": "ğŸ‡²ğŸ‡¬", "MH": "ğŸ‡²ğŸ‡­", "MK": "ğŸ‡²ğŸ‡°", "ML": "ğŸ‡²ğŸ‡±", "MM": "ğŸ‡²ğŸ‡²", "MN": "ğŸ‡²ğŸ‡³", "MR": "ğŸ‡²ğŸ‡·",
      "MT": "ğŸ‡²ğŸ‡¹", "MU": "ğŸ‡²ğŸ‡º", "MV": "ğŸ‡²ğŸ‡»", "MW": "ğŸ‡²ğŸ‡¼", "MX": "ğŸ‡²ğŸ‡½", "MY": "ğŸ‡²ğŸ‡¾", "MZ": "ğŸ‡²ğŸ‡¿", "NA": "ğŸ‡³ğŸ‡¦",
      "NE": "ğŸ‡³ğŸ‡ª", "NG": "ğŸ‡³ğŸ‡¬", "NI": "ğŸ‡³ğŸ‡®", "NL": "ğŸ‡³ğŸ‡±", "NO": "ğŸ‡³ğŸ‡´", "NP": "ğŸ‡³ğŸ‡µ", "NR": "ğŸ‡³ğŸ‡·", "NZ": "ğŸ‡³ğŸ‡¿",
      "OM": "ğŸ‡´ğŸ‡²", "PA": "ğŸ‡µğŸ‡¦", "PE": "ğŸ‡µğŸ‡ª", "PG": "ğŸ‡µğŸ‡¬", "PH": "ğŸ‡µğŸ‡­", "PK": "ğŸ‡µğŸ‡°", "PL": "ğŸ‡µğŸ‡±", "PT": "ğŸ‡µğŸ‡¹",
      "PW": "ğŸ‡µğŸ‡¼", "PY": "ğŸ‡µğŸ‡¾", "QA": "ğŸ‡¶ğŸ‡¦", "RO": "ğŸ‡·ğŸ‡´", "RU": "ğŸ‡·ğŸ‡º", "RW": "ğŸ‡·ğŸ‡¼", "SA": "ğŸ‡¸ğŸ‡¦", "SB": "ğŸ‡¸ğŸ‡§",
      "SC": "ğŸ‡¸ğŸ‡¨", "SD": "ğŸ‡¸ğŸ‡©", "SE": "ğŸ‡¸ğŸ‡ª", "SG": "ğŸ‡¸ğŸ‡¬", "SI": "ğŸ‡¸ğŸ‡®", "SK": "ğŸ‡¸ğŸ‡°", "SL": "ğŸ‡¸ğŸ‡±", "SM": "ğŸ‡¸ğŸ‡²",
      "SN": "ğŸ‡¸ğŸ‡³", "SO": "ğŸ‡¸ğŸ‡´", "SR": "ğŸ‡¸ğŸ‡·", "SS": "ğŸ‡¸ğŸ‡¸", "ST": "ğŸ‡¸ğŸ‡¹", "SV": "ğŸ‡¸ğŸ‡»", "SY": "ğŸ‡¸ğŸ‡¾", "SZ": "ğŸ‡¸ğŸ‡¿",
      "TD": "ğŸ‡¹ğŸ‡©", "TG": "ğŸ‡¹ğŸ‡¬", "TH": "ğŸ‡¹ğŸ‡­", "TJ": "ğŸ‡¹ğŸ‡¯", "TL": "ğŸ‡¹ğŸ‡±", "TM": "ğŸ‡¹ğŸ‡²", "TN": "ğŸ‡¹ğŸ‡³", "TO": "ğŸ‡¹ğŸ‡´",
      "TR": "ğŸ‡¹ğŸ‡·", "TT": "ğŸ‡¹ğŸ‡¹", "TV": "ğŸ‡¹ğŸ‡»", "TZ": "ğŸ‡¹ğŸ‡¿", "UA": "ğŸ‡ºğŸ‡¦", "UG": "ğŸ‡ºğŸ‡¬", "US": "ğŸ‡ºğŸ‡¸", "UY": "ğŸ‡ºğŸ‡¾",
      "UZ": "ğŸ‡ºğŸ‡¿", "VA": "ğŸ‡»ğŸ‡¦", "VC": "ğŸ‡»ğŸ‡¨", "VE": "ğŸ‡»ğŸ‡ª", "VN": "ğŸ‡»ğŸ‡³", "VU": "ğŸ‡»ğŸ‡º", "WF": "ğŸ‡¼ğŸ‡«", "WS": "ğŸ‡¼ğŸ‡¸",
      "YE": "ğŸ‡¾ğŸ‡ª", "ZA": "ğŸ‡¿ğŸ‡¦", "ZM": "ğŸ‡¿ğŸ‡²", "ZW": "ğŸ‡¿ğŸ‡¼"
    };

    const countryCode = result.country?.split(" ")[0] || "Unknown";
    const countryFlag = flags[countryCode] || "ğŸ³ï¸";

    const responseData = {
      isp: result.asOrganization,
      asn: result.asn,
      city: result.city,
      country: `${countryCode} ${countryFlag}`,
      ip: result.ip,
      port: port,
      origin: result.origin,
      vpn: result.proxyip,
      warp: result.warp,
      status: result.proxyip ? "ACTIVE âœ…" : "DEAD âŒ",
      delay: latency
    };

    // Simpan data ke localStorage dengan nama "proxyData"
    const jsonData = JSON.stringify(responseData, null, 2);
    
    return new Response(jsonData, {
      headers: { "Content-Type": "application/json" }
    });
    
    

  } catch (error) {
    const errorData = {
      isp: "Unknown",
      asn: "Unknown",
      city: "Unknown",
      country: "Unknown",
      ip: ip,
      port: port,
      origin: "Unknown",
      vpn: "Unknown",
      warp: "Unknown",
      status: "DEAD âŒ",
      delay: "0.ms"
    };
    return new Response(JSON.stringify(errorData, null, 2), {
      headers: { "Content-Type": "application/json" }
    });
  }
}

function generateHTML() {
  return `<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Checker</title>
    <meta property="og:image" content="https://kere.us.kg/img/botvpn.jpg"> <!-- Ganti dengan URL gambar yang sesuai -->
    <meta property="og:url" content="https://kere.us.kg/img/botvpn.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="og:type" content="website">
    <meta name="twitter:image" content="https://kere.us.kg/img/botvpn.jpg"> <!-- Ganti dengan URL gambar yang sesuai -->
    <link href="https://kere.us.kg/img/botvpn.jpg" rel="icon" type="image/png">
    <style>
    body { font-family: Arial, sans-serif; text-align: center; }
       
  header, footer {
      background-color: #45a049;
      color: white;
      padding: 10px 0;
      text-align: center;
  }
  header h1, footer p {
      margin: 0;
  }
  .container {
      margin-top: 10px;
      margin-bottom: 10px;
      margin: 10px;
      padding: 10px;
  }
input[type="text"] { padding: 8px; width: 150px; margin-bottom: 15px; }
        button { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        #loadinga { display: none; font-size: 18px; font-weight: bold; }
    
  table { margin: auto; border-collapse: collapse; width: 95%; max-width: 700px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #4CAF50; color: white; }
        td { padding: 8px 12px; }
        input[type="text"] { padding: 8px; width: 200px; margin-bottom: 10px; }
        button { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        #loading { display: none; font-size: 18px; font-weight: bold; }
    
    @keyframes moveColors {
  100% {
    background-position: -200%; /* Mulai dari luar kiri */
  }
  0% {
    background-position: 200%; /* Bergerak ke kanan */
  }
}

  #loading {
  display: none; font-size: 20px; font-weight: bold;
  
  background: linear-gradient(90deg, red, orange, yellow, green, blue, purple);
  background-size: 200%;
  color: transparent;
  -webkit-background-clip: text;
  animation: moveColors 5s linear infinite;
}
  
    </style>
</head>
<body>
<header>
<h1>Proxy Checker</h1>
</header>
<div class="container">
    <input type="text" id="ipInput" placeholder="Input IP:Port(192.168.1.1:443)" />
    <button onclick="checkProxy()">Cek</button>
    <p id="loading">Loading...</p>
    <table id="resultTable">
        <thead>
          <tr>
            <th>Key</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>ISP</td><td>-</td></tr>
          <tr><td>ASN</td><td>-</td></tr>
          <tr><td>City</td><td>-</td></tr>
          <tr><td>Country</td><td>-</td></tr>
          <tr><td>IP</td><td>-</td></tr>
          <tr><td>Port</td><td>-</td></tr>
          <tr><td>Origin</td><td>-</td></tr>
          <tr><td>VPN</td><td>-</td></tr>
          <tr><td>WARP</td><td>-</td></tr>
          <tr><td>Status</td><td>-</td></tr>
          <tr><td>Delay</td><td>-</td></tr>
        </tbody>
    </table>
    </div>
    <footer>
    <p>&copy; 2025 Proxy Checker. All rights reserved.</p>
</footer>
    <script>
        // Saat halaman dimuat, periksa jika ada data di localStorage
        window.onload = function() {
            const storedData = localStorage.getItem("proxyData");
            if (storedData) {
                const data = JSON.parse(storedData);
                updateTable(data);
            }
        };

        async function checkProxy() {
            const ipPort = document.getElementById("ipInput").value;
            if (!ipPort) {
                alert("Masukkan IP:Port terlebih dahulu!");
                return;
            }

            document.getElementById("loading").style.display = "block";  // Menampilkan loading

            const response = await fetch(\`/check?ip=\${encodeURIComponent(ipPort)}\`);
            const data = await response.json();

            // Simpan data ke localStorage
            localStorage.setItem("proxyData", JSON.stringify(data));

            updateTable(data);
            document.getElementById("loading").style.display = "none";  // Menyembunyikan loading
        }

        function updateTable(data) {
            const table = document.getElementById("resultTable");
            const tbody = table.querySelector("tbody");

            tbody.querySelectorAll("tr").forEach((row) => {
                const key = row.querySelector("td").textContent;
                const dataKey = key.toLowerCase();

                if (data[dataKey]) {
                    row.querySelectorAll("td")[1].textContent = data[dataKey] || "-";
                }
            });
        }
    </script>
</body>
</html>`;
}
